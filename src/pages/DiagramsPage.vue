<template>
  <q-page
    id="diagrams-page"
    v-touch-pan.mouse="handlePan"
    data-cy="diagrams-page"
  >
    <div
      id="diagrams-container"
      class="row q-gutter-md q-ma-md"
    >
      <q-card
        v-for="diagram in diagrams"
        :key="`diagram_${diagram.name}`"
        class="diagram-container col-2 no-shadow q-pa-md bg-grey-3"
        :data-cy="`diagram-card_${diagram.name}`"
      >
        <div
          :id="`diagram_${diagram.name}`"
          :data-cy="`diagram_${diagram.name}`"
        />
      </q-card>
    </div>
    <q-page-sticky :offset="[20, 20]">
      <q-btn-group>
        <q-btn
          icon="fa-solid fa-magnifying-glass-plus"
          :label="$t('page.diagrams.actions.zoomPlus')"
          stack
          no-caps
          color="white"
          text-color="black"
          data-cy="zoom-plus-button"
          @click="zoom(true)"
        />
        <q-btn
          icon="fa-solid fa-magnifying-glass-minus"
          :label="$t('page.diagrams.actions.zoomMinus')"
          stack
          no-caps
          color="white"
          text-color="black"
          data-cy="zoom-minus-button"
          @click="zoom(false)"
        />
      </q-btn-group>
    </q-page-sticky>
  </q-page>
</template>

<script setup>
import { getPluginByName, initComponents } from 'src/composables/PluginManager';
import { getAllModels } from 'src/composables/Project';
import {
  computed,
  onMounted,
  reactive,
  ref,
} from 'vue';
import { useRoute } from 'vue-router';

const route = useRoute();
const projectName = computed(() => route.params.projectName);
const diagrams = ref([]);
const defaultFolder = ref(process.env.MODELS_DEFAULT_FOLDER !== ''
  ? `${process.env.MODELS_DEFAULT_FOLDER}/`
  : '');
const scale = ref(1);
const translate = reactive({
  x: 0,
  y: 0,
});

/**
 * Zoom on diagrams container.
 * @param {Boolean} plus - Zoom in on true otherwise zoom out.
 */
function zoom(plus) {
  const div = document.getElementById('diagrams-container');

  if (plus && scale.value < 1) {
    scale.value *= 2;
  } else if (plus && scale.value >= 1) {
    scale.value += 0.5;
  } else if (scale.value >= 1) {
    scale.value -= 0.5;
  } else {
    scale.value /= 2;
  }

  div.style.scale = scale.value;
}

/**
 * Pan on diagrams container according on the delta.
 * @param {*} delta - Delta of distance (in pixels) since handler was called last time.
 * @see https://quasar.dev/vue-directives/touch-pan#handling-mouse-events
 */
function handlePan({ delta }) {
  const div = document.getElementById('diagrams-container');

  translate.x += delta.x;
  translate.y += delta.y;

  div.style.translate = `${translate.x}px ${translate.y}px`;
}

/**
 * Update diagrams list.
 * @returns {Promise<void>} Promise with nothing on success otherwise an error.
 */
async function updateDiagrams() {
  diagrams.value = await getAllModels(projectName.value);
}

/**
 * Draw read-only diagrams.
 * @returns {Promise<void>} Promise with nothing on success otherwise an error.
 */
async function drawDiagrams() {
  return Promise.allSettled(
    diagrams.value.map(async (diagram) => {
      const plugin = getPluginByName(diagram.plugin);

      return initComponents(
        projectName.value,
        plugin,
        `${defaultFolder.value}${diagram.plugin}/${diagram.name}`,
      ).then(() => {
        plugin.draw(`diagram_${diagram.name}`, true);
      });
    }),
  );
}

onMounted(async () => {
  await updateDiagrams();
  await drawDiagrams();
});
</script>

<style lang="scss" scoped>
#diagrams-page {
  max-height: 100%;
  max-width: 100%;
  overflow: hidden;
}
.diagram-container {
  border: 2px dashed $primary;
}
</style>
<style lang="scss">
// Quasar sets overflow to 'hidden' on all svg.
// In our case, it needs to be set to 'visible' to manage position with % in plugin models.
.diagram-container div svg {
  overflow: visible !important;
  display: unset;
  height: 100%;
  width: 100%;
}
</style>
